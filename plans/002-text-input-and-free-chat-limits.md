# План 002: Текстовый ввод и ограничение вопросов в FREE_CHAT

## Objective (Цель)

Улучшить UX диалога:
1. Добавить возможность текстового ввода на этапах BUDGET и DEADLINE (не только кнопки)
2. Реализовать ограничение количества вопросов в FREE_CHAT (3-5 вопросов)
3. Уменьшить нагромождение сообщений

## Context (Контекст)

Текущая проблема:
- Бот спрашивает и предлагает ТОЛЬКО кнопки на этапах бюджета/срока
- Пользователь не может написать свой ответ текстом
- После квалификации FREE_CHAT не ограничен — можно спрашивать бесконечно
- Сообщения нагромождаются (много отдельных сообщений подряд)

Желаемое поведение:
- Пользователь может выбрать кнопку ИЛИ написать текстом
- После 3-5 вопросов в FREE_CHAT предложить назначить встречу
- Группировка информации в меньшее количество сообщений

## Proposed Steps (Предлагаемые шаги)

### Шаг 1: Добавить текстовые handlers для BUDGET и DEADLINE

1.1. Создать `ConversationState.BUDGET_CUSTOM_INPUT` и `DEADLINE_CUSTOM_INPUT` states
1.2. Добавить message handlers для обработки текстового ввода бюджета/срока
1.3. Использовать LLM для парсинга произвольного текста в категории (или сохранять как есть)

### Шаг 2: Добавить счётчик вопросов в FREE_CHAT

2.1. Добавить поле `free_chat_count` в FSM state data
2.2. В `_handle_free_chat_logic()` инкрементировать счётчик после каждого ответа
2.3. После N вопросов (конфиг: 5 по умолчанию) показать кнопку "Назначить встречу" более явно

### Шаг 3: Улучшить keyboards для поддержки текстового ввода

3.1. Добавить подсказку "Или напишите свой вариант" под кнопками
3.2. Модифицировать handlers чтобы принимать текст без кнопок

### Шаг 4: Объединить сообщения для уменьшения нагромождения

4.1. Убрать отдельное "Генерирую вопросы..." — объединить с результатом
4.2. Объединить подтверждение с следующим вопросом

## Risks (Риски)

1. **Парсинг произвольного бюджета/срока** — LLM может неверно понять
   - Mitigation: Fallback — сохранять текст как есть без категоризации

2. **Изменение UX может сломать существующие сценарии**
   - Mitigation: Тестирование всех веток flow

## Rollback Strategy (Стратегия отката)

Откат через git revert если что-то пойдёт не так.

## Success Criteria (Критерии успеха)

1. ✅ Пользователь может ввести бюджет текстом (например "около 70 тысяч")
2. ✅ Пользователь может ввести срок текстом (например "к новому году")
3. ✅ После 5 вопросов в FREE_CHAT бот предлагает назначить встречу
4. ✅ Количество сообщений от бота уменьшено
5. ✅ Существующие кнопки продолжают работать

---

## Статус: ✅ ВЫПОЛНЕНО (23.12.2025)

### Реализовано:

1. **Новые FSM states** в `src/handlers/states.py`:
   - `BUDGET_CUSTOM_INPUT` — ожидание ввода бюджета текстом
   - `DEADLINE_CUSTOM_INPUT` — ожидание ввода срока текстом

2. **Конфигурация** в `src/config.py`:
   - `free_chat_max_questions: int = 5` — лимит вопросов до предложения встречи

3. **Клавиатуры** в `src/keyboards/__init__.py`:
   - Добавлена кнопка "✍️ Свой вариант" в `get_budget_keyboard()`
   - Добавлена кнопка "✍️ Свой вариант" в `get_deadline_keyboard()`
   - Добавлена `get_meeting_suggestion_keyboard()` для явного предложения встречи

4. **Handlers** в `src/handlers/conversation.py`:
   - `handle_budget_custom_input()` — обработка текстового ввода бюджета
   - `handle_deadline_custom_input()` — обработка текстового ввода срока
   - `_qualify_lead_custom()` — эвристическая квалификация для произвольного ввода
   - Обновлён `_handle_free_chat_logic()` — счётчик вопросов и предложение встречи
   - Обновлён `handle_message_without_state()` — поддержка текстового ввода в BUDGET/DEADLINE
   - Убрано лишнее сообщение "Генерирую вопросы..."

5. **Тесты** обновлены для нового количества кнопок
