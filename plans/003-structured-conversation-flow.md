# –ü–ª–∞–Ω 003: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å FSM –∏ –∫–Ω–æ–ø–∫–∞–º–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 22.12.2025
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

---

## Objective (–¶–µ–ª—å)

–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å –ª–∏–¥–∞–º–∏, –¥–æ–±–∞–≤–∏–≤ **—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π flow** —á–µ—Ä–µ–∑ FSM (Finite State Machine) –∏ inline –∫–Ω–æ–ø–∫–∏. –°–¥–µ–ª–∞—Ç—å –±–æ—Ç–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º, –ø–æ–Ω—è—Ç–Ω—ã–º –∏ –≤–µ–¥—É—â–∏–º –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—à–∞–≥–æ–≤–æ.

**–ü—Ä–æ–±–ª–µ–º–∞:**
–†–µ–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª—É—é—Ç—Å—è:
- "–ù–µ–ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –¥–µ–ª–∞—Ç—å –∏ –∫—É–¥–∞ –∏–¥—Ç–∏"
- "–ë–æ—Ç –∑–∞–¥–∞–µ—Ç 3 –≤–æ–ø—Ä–æ—Å–∞ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ"
- "–í–æ–ø—Ä–æ—Å—ã —Ä–∞–∑–º—ã—Ç—ã–µ, –Ω–µ —Ç–æ—á–Ω—ã–µ"
- "–ù–µ—Ç –∫–Ω–æ–ø–æ–∫ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏"

**–†–µ—à–µ–Ω–∏–µ:**
–ì–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: **—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (FSM) + –≥–∏–±–∫–æ—Å—Ç—å (LLM)**

---

## Context (–ö–æ–Ω—Ç–µ–∫—Å—Ç)

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- ‚ùå –í—Å—è –ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º handler (`conversation.py`)
- ‚ùå –ù–µ—Ç state management (FSM)
- ‚ùå Claude AI –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –∫–∞–∫ —Ö–æ—á–µ—Ç (3+ –≤–æ–ø—Ä–æ—Å–∞ —Å—Ä–∞–∑—É)
- ‚ùå –ù–µ—Ç inline –∫–Ω–æ–ø–æ–∫ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ flow
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è

### –¶–µ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- ‚úÖ –ß–µ—Ç–∫–∏–µ —ç—Ç–∞–ø—ã: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí –ó–∞–¥–∞—á–∞ ‚Üí –ë—é–¥–∂–µ—Ç ‚Üí –°—Ä–æ–∫ ‚Üí –î–µ–π—Å—Ç–≤–∏–µ
- ‚úÖ FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞–º–∏ (aiogram FSM)
- ‚úÖ Inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
- ‚úÖ LLM –¥–ª—è —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–∞–ø–∞
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ LLM (–Ω–µ –≤–µ—Å—å –¥–∏–∞–ª–æ–≥, –∞ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø)
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (üìã –ó–∞–¥–∞—á–∞ ‚Üí üí∞ –ë—é–¥–∂–µ—Ç ‚Üí ‚è∞ –°—Ä–æ–∫)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:
1. **aiogram FSM** –¥–ª—è state management
2. **InlineKeyboardMarkup** –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
3. **–ü—Ä–æ–º–ø—Ç-–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥**: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Claude –¥–æ 1 –≤–æ–ø—Ä–æ—Å–∞
4. **Callback handlers** —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
5. **–í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å** (—ç–º–æ–¥–∑–∏ + —ç—Ç–∞–ø—ã)

---

## Proposed Steps (–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ —à–∞–≥–∏)

### –≠—Ç–∞–ø 1: –î–∏–∑–∞–π–Ω User Flow (1 —á–∞—Å)

**–¶–µ–ª—å:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ç–∫–∏–µ —ç—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞ –∏ –∫–Ω–æ–ø–∫–∏.

#### 1.1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `docs/user-flow-v2.md`:

```markdown
# –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π User Flow v2

## –≠—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞:

### 1Ô∏è‚É£ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (Welcome)
- **–¢—Ä–∏–≥–≥–µ—Ä:** /start –∏–ª–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- **–î–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞:**
  - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: "–ü—Ä–∏–≤–µ—Ç! üëã –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç [–ë–∏–∑–Ω–µ—Å]."
  - –í–æ–ø—Ä–æ—Å: "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–∞—è –∑–∞–¥–∞—á–∞ —É –≤–∞—Å –µ—Å—Ç—å?"
  - **–ö–Ω–æ–ø–∫–∏:**
    - [üì± –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞]
    - [üé® –î–∏–∑–∞–π–Ω]
    - [üíª –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è]
    - [‚úçÔ∏è –°–≤–æ—è –∑–∞–¥–∞—á–∞] ‚Üí –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
- **State:** `ConversationState.TASK`

### 2Ô∏è‚É£ –ó–∞–¥–∞—á–∞ (Task)
- **–¢—Ä–∏–≥–≥–µ—Ä:** –í—ã–±–æ—Ä –∫–Ω–æ–ø–∫–∏ –∏–ª–∏ –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
- **–î–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞:**
  - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: "–û—Ç–ª–∏—á–Ω–æ! [–∑–∞–¥–∞—á–∞]"
  - –í–æ–ø—Ä–æ—Å: "–ö–∞–∫–æ–π —É –≤–∞—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç?"
  - **–ö–Ω–æ–ø–∫–∏:**
    - [üí∞ –î–æ 50 000 ‚ÇΩ]
    - [üí∞ 50 000 - 150 000 ‚ÇΩ]
    - [üí∞ 150 000+ ‚ÇΩ]
    - [ü§∑ –ü–æ–∫–∞ –Ω–µ –∑–Ω–∞—é]
- **State:** `ConversationState.BUDGET`

### 3Ô∏è‚É£ –ë—é–¥–∂–µ—Ç (Budget)
- **–¢—Ä–∏–≥–≥–µ—Ä:** –í—ã–±–æ—Ä –∫–Ω–æ–ø–∫–∏
- **–î–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞:**
  - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: "–ü–æ–Ω—è–ª!"
  - –í–æ–ø—Ä–æ—Å: "–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?"
  - **–ö–Ω–æ–ø–∫–∏:**
    - [üî• –°—Ä–æ—á–Ω–æ (–Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ)]
    - [‚è∞ –°–∫–æ—Ä–æ (–≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ)]
    - [üìÖ –ù–µ —Å—Ä–æ—á–Ω–æ (–µ—Å—Ç—å –≤—Ä–µ–º—è)]
- **State:** `ConversationState.DEADLINE`

### 4Ô∏è‚É£ –°—Ä–æ–∫ (Deadline)
- **–¢—Ä–∏–≥–≥–µ—Ä:** –í—ã–±–æ—Ä –∫–Ω–æ–ø–∫–∏
- **–î–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞:**
  - –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è (HOT/WARM/COLD)
  - –ï—Å–ª–∏ HOT:
    - "–û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ–µ–∫—Ç —Å—Ä–æ—á–Ω—ã–π –∏ –≤–∞–∂–Ω—ã–π."
    - **–î–µ–π—Å—Ç–≤–∏–µ:** –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É (inline keyboard)
  - –ï—Å–ª–∏ WARM:
    - "–ü–æ–Ω—è–ª! –û—Ç–ø—Ä–∞–≤–ª—é –≤–∞–º –Ω–∞—à–∏ –∫–µ–π—Å—ã."
    - **–î–µ–π—Å—Ç–≤–∏–µ:** –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã + follow-up
  - –ï—Å–ª–∏ COLD:
    - "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å! –ë—É–¥—É –Ω–∞ —Å–≤—è–∑–∏."
    - **–î–µ–π—Å—Ç–≤–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –≤ nurture-—Ü–µ–ø–æ—á–∫—É
- **State:** `ConversationState.ACTION`

### 5Ô∏è‚É£ –°–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ª–æ–≥ (Free Chat)
- **–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏, –µ—Å–ª–∏ –ª–∏–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–∏—Å–∞—Ç—å
- **–î–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞:**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Claude –¥–ª—è —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
  - **–ö–Ω–æ–ø–∫–∏:**
    - [üìÖ –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É] (–µ—Å–ª–∏ HOT/WARM)
    - [üìÇ –ü–æ–ª—É—á–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã]
    - [üìä –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ]
- **State:** `ConversationState.FREE_CHAT`

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –∑–Ω–∞–µ—Ç, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è
- ‚úÖ –û–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑ (–Ω–µ overwhelm)
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–≤–µ—Å—Ç–∏ —Å–≤–æ–π —Ç–µ–∫—Å—Ç
- ‚úÖ –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤
```

#### 1.2. –£—Ç–≤–µ—Ä–¥–∏—Ç—å —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º (—Ç—ã)

**–ß–µ–∫–ø–æ–∏–Ω—Ç:** –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ User Flow –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π.

---

### –≠—Ç–∞–ø 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è FSM (2-3 —á–∞—Å–∞)

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å states –∏ –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É FSM.

#### 2.1. –°–æ–∑–¥–∞—Ç—å `src/handlers/states.py`:

```python
from aiogram.fsm.state import State, StatesGroup

class ConversationState(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å –ª–∏–¥–æ–º."""
    TASK = State()       # –í—ã—è—Å–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    BUDGET = State()     # –í—ã—è—Å–Ω–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞
    DEADLINE = State()   # –í—ã—è—Å–Ω–µ–Ω–∏–µ —Å—Ä–æ–∫–∞
    ACTION = State()     # –î–µ–π—Å—Ç–≤–∏–µ (–≤—Å—Ç—Ä–µ—á–∞/–º–∞—Ç–µ—Ä–∏–∞–ª—ã)
    FREE_CHAT = State()  # –°–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ª–æ–≥ –ø–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏
```

#### 2.2. –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å `src/handlers/conversation.py`:

**–†–∞–∑–±–∏—Ç—å –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ handlers –¥–ª—è –∫–∞–∂–¥–æ–≥–æ state:**

- `handle_task_input()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á–∏ (state=TASK)
- `handle_budget_selection()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—é–¥–∂–µ—Ç–∞ (state=BUDGET)
- `handle_deadline_selection()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ä–æ–∫–∞ (state=DEADLINE)
- `handle_action()` ‚Äî –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –¥–µ–π—Å—Ç–≤–∏–µ (state=ACTION)
- `handle_free_chat()` ‚Äî —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ª–æ–≥ (state=FREE_CHAT)

**–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**

```python
@router.message(ConversationState.TASK)
async def handle_task_input(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –∑–∞–¥–∞—á–∏."""
    task = message.text

    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ FSM context
    await state.update_data(task=task)

    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
    lead = await Lead.get(telegram_id=message.from_user.id)
    lead.task = task
    await lead.save()

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å –æ –±—é–¥–∂–µ—Ç–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    keyboard = InlineKeyboardMarkup(...)
    await message.answer(
        f"–û—Ç–ª–∏—á–Ω–æ! {task}\n\n–ö–∞–∫–æ–π —É –≤–∞—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç?",
        reply_markup=keyboard
    )

    # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É state
    await state.set_state(ConversationState.BUDGET)
```

#### 2.3. –û–±–Ω–æ–≤–∏—Ç—å `src/handlers/start.py`:

–ü—Ä–∏ `/start` –∏–ª–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏:
- –°–æ–∑–¥–∞—Ç—å –ª–∏–¥–∞
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å state = `ConversationState.TASK`
- –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –∑–∞–¥–∞—á–∏

#### 2.4. –î–æ–±–∞–≤–∏—Ç—å FSM storage –≤ `src/bot.py`:

```python
from aiogram.fsm.storage.memory import MemoryStorage

storage = MemoryStorage()
dp = Dispatcher(storage=storage)
```

**AICODE-NOTE:** –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –∑–∞–º–µ–Ω–∏—Ç—å MemoryStorage –Ω–∞ RedisStorage (–ø–æ—Å–ª–µ MVP).

---

### –≠—Ç–∞–ø 3: Inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ (2 —á–∞—Å–∞)

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫.

#### 3.1. –°–æ–∑–¥–∞—Ç—å `src/keyboards/__init__.py`:

```python
"""–ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä."""

from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

def get_task_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ –∑–∞–¥–∞—á–∏."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üì± –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞", callback_data="task:website")],
        [InlineKeyboardButton(text="üé® –î–∏–∑–∞–π–Ω", callback_data="task:design")],
        [InlineKeyboardButton(text="üíª –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è", callback_data="task:app")],
        [InlineKeyboardButton(text="‚úçÔ∏è –°–≤–æ—è –∑–∞–¥–∞—á–∞", callback_data="task:custom")],
    ])

def get_budget_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ –±—é–¥–∂–µ—Ç–∞."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üí∞ –î–æ 50 000 ‚ÇΩ", callback_data="budget:low")],
        [InlineKeyboardButton(text="üí∞ 50 000 - 150 000 ‚ÇΩ", callback_data="budget:medium")],
        [InlineKeyboardButton(text="üí∞ 150 000+ ‚ÇΩ", callback_data="budget:high")],
        [InlineKeyboardButton(text="ü§∑ –ü–æ–∫–∞ –Ω–µ –∑–Ω–∞—é", callback_data="budget:unknown")],
    ])

def get_deadline_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Å—Ä–æ–∫–∞."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üî• –°—Ä–æ—á–Ω–æ (–Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ)", callback_data="deadline:urgent")],
        [InlineKeyboardButton(text="‚è∞ –°–∫–æ—Ä–æ (–≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ)", callback_data="deadline:soon")],
        [InlineKeyboardButton(text="üìÖ –ù–µ —Å—Ä–æ—á–Ω–æ (–µ—Å—Ç—å –≤—Ä–µ–º—è)", callback_data="deadline:later")],
    ])

def get_action_keyboard(status: LeadStatus) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏."""
    buttons = []

    if status in [LeadStatus.HOT, LeadStatus.WARM]:
        buttons.append([InlineKeyboardButton(
            text="üìÖ –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É",
            callback_data="action:schedule_meeting"
        )])

    buttons.append([InlineKeyboardButton(
        text="üìÇ –ü–æ–ª—É—á–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã",
        callback_data="action:send_materials"
    )])

    buttons.append([InlineKeyboardButton(
        text="üí¨ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
        callback_data="action:free_chat"
    )])

    return InlineKeyboardMarkup(inline_keyboard=buttons)
```

#### 3.2. –°–æ–∑–¥–∞—Ç—å callback handlers –¥–ª—è –∫–Ω–æ–ø–æ–∫:

```python
@router.callback_query(F.data.startswith("task:"))
async def handle_task_callback(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∑–∞–¥–∞—á–∏."""
    task_type = callback.data.split(":")[1]

    if task_type == "custom":
        await callback.message.answer("–ù–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∞—è –∑–∞–¥–∞—á–∞ —É –≤–∞—Å –µ—Å—Ç—å:")
        await callback.answer()
        return

    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å task_type –≤ —Ç–µ–∫—Å—Ç
    task_map = {
        "website": "–°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞",
        "design": "–î–∏–∑–∞–π–Ω",
        "app": "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
    }
    task = task_map.get(task_type, "–ù–µ —É–∫–∞–∑–∞–Ω–æ")

    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
    await state.update_data(task=task)
    lead = await Lead.get(telegram_id=callback.from_user.id)
    lead.task = task
    await lead.save()

    # –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
    await callback.message.edit_text(f"‚úÖ –ó–∞–¥–∞—á–∞: {task}")
    await callback.message.answer(
        "–ö–∞–∫–æ–π —É –≤–∞—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç?",
        reply_markup=get_budget_keyboard()
    )
    await state.set_state(ConversationState.BUDGET)
    await callback.answer()
```

#### 3.3. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π:

**–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–∂–¥—ã–π callback handler:**

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ callback –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–Ω–æ–ø–∫–∏
if callback.from_user.id != lead.telegram_id:
    await callback.answer("‚ùå –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å", show_alert=True)
    return

# –û—Ç–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è
await callback.message.edit_reply_markup(reply_markup=None)
```

---

### –≠—Ç–∞–ø 4: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ LLM (1 —á–∞—Å)

**–¶–µ–ª—å:** Claude –¥–æ–ª–∂–µ–Ω –∑–∞–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ 1 —Ç–æ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∞ –Ω–µ 3.

#### 4.1. –û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ `src/services/llm.py`:

**–î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–æ–º–ø—Ç:**

```python
**–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:**
1. –ó–∞–¥–∞–≤–∞–π –¢–û–õ–¨–ö–û –û–î–ò–ù –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑, –∞ –Ω–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ä–∞–∑—É.
2. –í–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ú –∏ –ö–û–†–û–¢–ö–ò–ú (–º–∞–∫—Å–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
3. –ù–ï –¥—É–±–ª–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é —É–∂–µ –∑–Ω–∞–µ—à—å.
4. –ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω, –Ω–æ –±—É–¥—å –ª–∞–∫–æ–Ω–∏—á–µ–Ω.

**–ü–ª–æ—Ö–æ–π –ø—Ä–∏–º–µ—Ä:**
"–û—Ç–ª–∏—á–Ω–æ! –ö–∞–∫–æ–π —É –≤–∞—Å –±—é–¥–∂–µ—Ç? –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ? –ö–∞–∫–∏–µ –µ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è?"

**–•–æ—Ä–æ—à–∏–π –ø—Ä–∏–º–µ—Ä:**
"–ö–∞–∫–æ–π —É –≤–∞—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞ –ø—Ä–æ–µ–∫—Ç?"
```

#### 4.2. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å max_tokens:

```python
response = await client.messages.create(
    model=MODEL,
    max_tokens=256,  # –ë—ã–ª–æ 1024 ‚Üí —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ 256
    system=system_prompt,
    messages=messages,
)
```

**AICODE-NOTE:** –ú–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí –∫–æ—Ä–æ—á–µ –æ—Ç–≤–µ—Ç—ã ‚Üí –º–µ–Ω—å—à–µ —à–∞–Ω—Å –∑–∞–¥–∞—Ç—å 3 –≤–æ–ø—Ä–æ—Å–∞.

#### 4.3. –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é:

–í–º–µ—Å—Ç–æ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞, –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ:
- –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ state (—á—Ç–æ —É–∂–µ –∑–Ω–∞–µ–º)
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2-3 —Å–æ–æ–±—â–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä:**

```python
# –í–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏:
# conversation_history = await Conversation.filter(lead=lead).order_by("created_at").all()

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç FSM:
fsm_data = await state.get_data()
context = f"–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø: {state.get_state()}. –ò–∑–≤–µ—Å—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: task={fsm_data.get('task')}"
```

---

### –≠—Ç–∞–ø 5: –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (30 –º–∏–Ω—É—Ç)

**–¶–µ–ª—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è.

#### 5.1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:

```python
def get_progress_indicator(current_state: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞."""
    states = {
        "TASK": "üìã –ó–∞–¥–∞—á–∞",
        "BUDGET": "üí∞ –ë—é–¥–∂–µ—Ç",
        "DEADLINE": "‚è∞ –°—Ä–æ–∫",
        "ACTION": "‚úÖ –î–µ–π—Å—Ç–≤–∏–µ",
    }

    progress = []
    for state_name, label in states.items():
        if state_name == current_state:
            progress.append(f"**{label}** ‚Üê")  # –¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø
        elif states.keys().index(state_name) < states.keys().index(current_state):
            progress.append(f"‚úÖ {label}")  # –ü—Ä–æ–π–¥–µ–Ω–Ω—ã–π —ç—Ç–∞–ø
        else:
            progress.append(f"‚ö™Ô∏è {label}")  # –ë—É–¥—É—â–∏–π —ç—Ç–∞–ø

    return " ‚Üí ".join(progress)
```

#### 5.2. –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞:

```python
progress = get_progress_indicator("BUDGET")
await message.answer(
    f"{progress}\n\n–ö–∞–∫–æ–π —É –≤–∞—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç?",
    reply_markup=get_budget_keyboard()
)
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**

```
‚úÖ –ó–∞–¥–∞—á–∞ ‚Üí **üí∞ –ë—é–¥–∂–µ—Ç** ‚Üê ‚Üí ‚ö™Ô∏è –°—Ä–æ–∫ ‚Üí ‚ö™Ô∏è –î–µ–π—Å—Ç–≤–∏–µ

–ö–∞–∫–æ–π —É –≤–∞—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç?
[–ö–Ω–æ–ø–∫–∏]
```

---

### –≠—Ç–∞–ø 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞ (2 —á–∞—Å–∞)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —ç—Ç–∞–ø—ã, –∫–Ω–æ–ø–∫–∏, –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é.

#### 6.1. –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

**–¢–µ—Å—Ç 1: –ì–æ—Ä—è—á–∏–π –ª–∏–¥ (HOT)**
- /start ‚Üí –∫–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞" ‚Üí "150 000+ ‚ÇΩ" ‚Üí "–°—Ä–æ—á–Ω–æ" ‚Üí –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É

**–¢–µ—Å—Ç 2: –¢—ë–ø–ª—ã–π –ª–∏–¥ (WARM)**
- /start ‚Üí —Å–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Üí "50 000 - 150 000 ‚ÇΩ" ‚Üí "–°–∫–æ—Ä–æ" ‚Üí –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã

**–¢–µ—Å—Ç 3: –•–æ–ª–æ–¥–Ω—ã–π –ª–∏–¥ (COLD)**
- /start ‚Üí –∫–Ω–æ–ø–∫–∞ ‚Üí "–ü–æ–∫–∞ –Ω–µ –∑–Ω–∞—é" ‚Üí "–ù–µ —Å—Ä–æ—á–Ω–æ" ‚Üí –¥–æ–ª–∂–µ–Ω –¥–æ–±–∞–≤–∏—Ç—å –≤ nurture

**–¢–µ—Å—Ç 4: –ó–∞—â–∏—Ç–∞ –∫–Ω–æ–ø–æ–∫**
- –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É 2 —Ä–∞–∑–∞ ‚Üí –¥–æ–ª–∂–Ω–∞ –æ—Ç–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è

**–¢–µ—Å—Ç 5: –°–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ª–æ–≥**
- –ü–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –≤–æ–ø—Ä–æ—Å ‚Üí –±–æ—Ç –¥–æ–ª–∂–µ–Ω —É–º–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Claude

#### 6.2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:

- –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ `logs/bot.log`
- FSM state transitions –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### 6.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é –∏ –ª–∏–Ω—Ç–∏–Ω–≥:

```bash
make check
```

---

### –≠—Ç–∞–ø 7: –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–∏–¥–æ–≤ (30 –º–∏–Ω—É—Ç)

**–¶–µ–ª—å:** –õ–∏–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –≤ –±–∞–∑–µ, –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–æ–≤—ã–º flow.

#### 7.1. –°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `/restart`:

–ü–æ–∑–≤–æ–ª—è–µ—Ç –ª–∏–¥—É –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ –∑–∞–Ω–æ–≤–æ:

```python
@router.message(Command("restart"))
async def cmd_restart(message: Message, state: FSMContext):
    """–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥."""
    await state.clear()
    await cmd_start(message, state)
```

#### 7.2. Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ª–∏–¥–æ–≤:

–ï—Å–ª–∏ –ª–∏–¥ –ø–∏—à–µ—Ç –±–µ–∑ state:

```python
@router.message(F.text)
async def handle_message_without_state(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ª–∏–¥–æ–≤ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ state."""
    current_state = await state.get_state()

    if not current_state:
        # –õ–∏–¥ –Ω–µ –≤ –¥–∏–∞–ª–æ–≥–µ ‚Üí –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
        await message.answer(
            "–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å–Ω–∞—á–∞–ª–∞! üòä\n"
            "–ù–∞–∂–º–∏—Ç–µ /start –∏–ª–∏ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–∞—è –∑–∞–¥–∞—á–∞ —É –≤–∞—Å –µ—Å—Ç—å?"
        )
        await state.set_state(ConversationState.TASK)
```

---

### –≠—Ç–∞–ø 8: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –¥–µ–ø–ª–æ–π (1 —á–∞—Å)

**–¶–µ–ª—å:** –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ VPS.

#### 8.1. –û–±–Ω–æ–≤–∏—Ç—å `docs/product.md`:

- –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "User Flow v2" —Å –Ω–æ–≤—ã–º–∏ —ç—Ç–∞–ø–∞–º–∏ –∏ –∫–Ω–æ–ø–∫–∞–º–∏

#### 8.2. –û–±–Ω–æ–≤–∏—Ç—å `docs/tech.md`:

- –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ FSM (aiogram states)
- –û–ø–∏—Å–∞—Ç—å keyboards –º–æ–¥—É–ª—å
- –û–±–Ω–æ–≤–∏—Ç—å Data Flow —Å—Ö–µ–º—É

#### 8.3. –û–±–Ω–æ–≤–∏—Ç—å `README.md`:

- –î–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã inline –∫–Ω–æ–ø–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### 8.4. –î–µ–ø–ª–æ–π –Ω–∞ VPS:

```bash
# –ù–∞ VPS
cd /root/ai-sales-assistant
git pull origin main
docker compose down
docker compose up -d --build
docker compose logs -f bot
```

#### 8.5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º –±–æ—Ç–æ–º
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü—É

---

## Risks (–†–∏—Å–∫–∏)

### 1. FSM –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –ö–æ–º–º–∏—Ç–∏–º –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø –æ—Ç–¥–µ–ª—å–Ω–æ
- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π `conversation.py` –∫–∞–∫ `conversation_old.py` –¥–ª—è –æ—Ç–∫–∞—Ç–∞
- Fallback –¥–ª—è –ª–∏–¥–æ–≤ –±–µ–∑ state

### 2. –ö–Ω–æ–ø–∫–∏ –º–æ–≥—É—Ç –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç—å
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –í—Å–µ–≥–¥–∞ –µ—Å—Ç—å –æ–ø—Ü–∏—è "–°–≤–æ—è –∑–∞–¥–∞—á–∞" / "–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç"
- –ü–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ ‚Äî —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ª–æ–≥ (FREE_CHAT state)

### 3. MemoryStorage —Ç–µ—Ä—è–µ—Ç state –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –î–ª—è MVP: –ø—Ä–∏–µ–º–ª–µ–º–æ (–ª–∏–¥ –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–µ—Ç –∑–∞–Ω–æ–≤–æ)
- –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞: –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ RedisStorage (–ø–æ—Å–ª–µ MVP)

### 4. LLM –º–æ–∂–µ—Ç –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ max_tokens (256 –≤–º–µ—Å—Ç–æ 1024)
- –°—Ç—Ä–æ–≥–∏–π –ø—Ä–æ–º–ø—Ç: "–¢–û–õ–¨–ö–û –û–î–ò–ù –≤–æ–ø—Ä–æ—Å"
- Post-processing: –ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç –∏ –±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ

---

## Rollback Strategy (–°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—Ç–∫–∞—Ç–∞)

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫:

1. **–û—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ Git:**
   ```bash
   git revert <commit>
   ```

2. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç–∞—Ä—ã–π handler:**
   - –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ handlers
   - –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π `conversation.py`

3. **–£–¥–∞–ª–µ–Ω–∏–µ FSM:**
   - –£–±—Ä–∞—Ç—å `storage=MemoryStorage()` –∏–∑ `bot.py`
   - –£–±—Ä–∞—Ç—å `@router.message(ConversationState.TASK)` –∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `@router.message(F.text)`

4. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
   - –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è (–Ω–æ–≤—ã–µ –ø–æ–ª—è –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è)
   - –û—Ç–∫–∞—Ç –ë–î –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

---

## Success Criteria (–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞)

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (Must Have):
- ‚úÖ –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –¥–∏–∞–ª–æ–≥–∞ –∏–º–µ–µ—Ç inline –∫–Ω–æ–ø–∫–∏
- ‚úÖ –ë–æ—Ç –∑–∞–¥–∞–µ—Ç –¢–û–õ–¨–ö–û 1 –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å (–≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)
- ‚úÖ –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫
- ‚úÖ FSM —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –Ω–æ–≤—ã—Ö –ª–∏–¥–æ–≤
- ‚úÖ Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ª–∏–¥–æ–≤ –±–µ–∑ state

### –ñ–µ–ª–∞–µ–º—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (Nice to Have):
- ‚úÖ –°–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ª–æ–≥ –ø–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ (FREE_CHAT state)
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ /restart –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –¥–∏–∞–ª–æ–≥–∞
- ‚úÖ –õ–æ–≥–∏ FSM transitions
- ‚úÖ MyPy + Ruff –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ –æ—à–∏–±–æ–∫

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –¥–µ–ø–ª–æ—é:
- [ ] –ü–æ–ª–Ω—ã–π User Flow –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –≤—Ä—É—á–Ω—É—é (–≤—Å–µ 3 —Å—Ü–µ–Ω–∞—Ä–∏—è: HOT/WARM/COLD)
- [ ] –ö–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç, –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è
- [ ] –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü—É –ø—Ä–∏—Ö–æ–¥—è—Ç
- [ ] –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ (–Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫)
- [ ] `make check` –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- [ ] –†–µ–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π feedback)

---

**–ò—Ç–æ–≥–æ: 10-12 —á–∞—Å–æ–≤ —á–∏—Å—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏**

---

## Next Steps After Implementation

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
1. –°–æ–±—Ä–∞—Ç—å feedback –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–µ –º–µ–Ω–µ–µ 5 —á–µ–ª–æ–≤–µ–∫)
2. –ò—Ç–µ—Ä–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ feedback (–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫, –≤–æ–ø—Ä–æ—Å–æ–≤)
3. –ó–∞–º–µ–Ω–∏—Ç—å MemoryStorage –Ω–∞ RedisStorage (–¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
4. –î–æ–±–∞–≤–∏—Ç—å analytics (—Å–∫–æ–ª—å–∫–æ –ª–∏–¥–æ–≤ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞)
5. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∫–Ω–æ–ø–æ–∫ –∏ –≤–æ–ø—Ä–æ—Å–æ–≤

---

**–ü–ª–∞–Ω –≥–æ—Ç–æ–≤ –∫ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é. –û–∂–∏–¥–∞—é "–û–∫" –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é.**
