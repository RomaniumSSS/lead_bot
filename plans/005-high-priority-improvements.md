# –ü–ª–∞–Ω: –í—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

## –ó–∞–¥–∞—á–∏

| # | –ó–∞–¥–∞—á–∞ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í—Ä–µ–º—è |
|---|--------|-----------|-------|
| 1 | Retry –¥–ª—è Claude API | –ù–∏–∑–∫–∞—è | 30 –º–∏–Ω |
| 2 | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ | –ù–∏–∑–∫–∞—è | 30 –º–∏–Ω |
| 3 | –ü–∞—Ä—Å–∏–Ω–≥ —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ | –°—Ä–µ–¥–Ω—è—è | 1-2 —á–∞—Å–∞ |
| 4 | Follow-up –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è | –°—Ä–µ–¥–Ω—è—è | 2-3 —á–∞—Å–∞ |

---

## 1. Retry –¥–ª—è Claude API

### –ü—Ä–æ–±–ª–µ–º–∞
–°–µ–π—á–∞—Å –ø—Ä–∏ –æ—à–∏–±–∫–µ 429 (rate limit) –∏–ª–∏ 500 (server error) –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ –ø–∞–¥–∞–µ—Ç —Å fallback-–æ—Ç–≤–µ—Ç–æ–º.

### –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–∏—Ç—å `tenacity` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö retry —Å exponential backoff.

### –§–∞–π–ª—ã
- `src/services/llm.py` (—Å—Ç—Ä–æ–∫–∞ 245)
- `pyproject.toml` (–¥–æ–±–∞–≤–∏—Ç—å `tenacity`)

### –ö–æ–¥

```python
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type
from anthropic import RateLimitError, APIStatusError

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=30),
    retry=retry_if_exception_type((RateLimitError, APIStatusError)),
    before_sleep=lambda retry_state: logger.warning(
        f"Retry {retry_state.attempt_number} after error: {retry_state.outcome.exception()}"
    )
)
async def _call_claude(client, messages, system_prompt):
    return await client.messages.create(...)
```

### –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –ü—Ä–∏ –æ—à–∏–±–∫–µ 429 –±–æ—Ç –∂–¥—ë—Ç –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å (–¥–æ 3 —Ä–∞–∑)
- –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ "Retry 1 after error..."

---

## 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞

### –ü—Ä–æ–±–ª–µ–º–∞
Claude API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç prompt caching ‚Äî —ç–∫–æ–Ω–æ–º–∏—è –¥–æ 90% —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ø—Ä–æ–º–ø—Ç–µ.

### –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–∏—Ç—å `cache_control` –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç.

### –§–∞–π–ª—ã
- `src/services/llm.py`

### –ö–æ–¥

```python
# –í create() –≤—ã–∑–æ–≤–µ
response = await client.messages.create(
    model="claude-sonnet-4-20250514",
    max_tokens=1024,
    system=[
        {
            "type": "text",
            "text": system_prompt,
            "cache_control": {"type": "ephemeral"}  # –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç
        }
    ],
    messages=messages,
)
```

### –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –í response.usage –≤–∏–¥–Ω–æ `cache_read_input_tokens > 0` –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –°–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ API

---

## 3. –ü–∞—Ä—Å–∏–Ω–≥ —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∏

### –ü—Ä–æ–±–ª–µ–º–∞
–ö–æ–≥–¥–∞ –ª–∏–¥ –≤—ã–±–∏—Ä–∞–µ—Ç "–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–≤–æ—ë –≤—Ä–µ–º—è" –∏ –ø–∏—à–µ—Ç "–∑–∞–≤—Ç—Ä–∞ –≤ 15:00" –∏–ª–∏ "–≤ —Å—Ä–µ–¥—É –≤ 11:00" ‚Äî —ç—Ç–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è.

### –†–µ—à–µ–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Claude –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –≤ datetime.

### –§–∞–π–ª—ã
- `src/handlers/meetings.py`
- `src/handlers/states.py` (–¥–æ–±–∞–≤–∏—Ç—å state MEETING_CUSTOM_TIME)

### –õ–æ–≥–∏–∫–∞

1. –õ–∏–¥ –≤—ã–±–∏—Ä–∞–µ—Ç "–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–≤–æ—ë –≤—Ä–µ–º—è"
2. –ë–æ—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ state `MEETING_CUSTOM_TIME`
3. –õ–∏–¥ –ø–∏—à–µ—Ç: "–≤ —Å—Ä–µ–¥—É –≤ 11:00"
4. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ Claude —Å –ø—Ä–æ–º–ø—Ç–æ–º:
   ```
   –°–µ–≥–æ–¥–Ω—è: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 23 –¥–µ–∫–∞–±—Ä—è 2025.
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª: "–≤ —Å—Ä–µ–¥—É –≤ 11:00"
   –í–µ—Ä–Ω–∏ JSON: {"date": "2025-12-25", "time": "11:00"}
   ```
5. –ë–æ—Ç —Å–æ–∑–¥–∞—ë—Ç Meeting —Å parsed datetime

### –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- "–∑–∞–≤—Ç—Ä–∞ –≤ 15:00" ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞
- "–≤ –ø—è—Ç–Ω–∏—Ü—É –≤ 10:00" ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞
- –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –≤–≤–æ–¥ ‚Üí "–ù–µ –ø–æ–Ω—è–ª, —É–∫–∞–∂–∏—Ç–µ –¥–µ–Ω—å –∏ –≤—Ä–µ–º—è"

---

## 4. Follow-up –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞
–ï—Å–ª–∏ –ª–∏–¥ –ø–µ—Ä–µ—Å—Ç–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ª–æ–≥–∞ ‚Äî –±–æ—Ç –Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –æ —Å–µ–±–µ.

### –†–µ—à–µ–Ω–∏–µ
–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä–∞—è:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–¥–æ–≤ —Å `last_message_at` > 24 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º—è–≥–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
3. –ü–æ—Å–ª–µ 2-–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ COLD

### –§–∞–π–ª—ã
- `src/services/scheduler.py` (—Å–æ–∑–¥–∞—Ç—å)
- `src/bot.py` (–∑–∞–ø—É—Å–∫ scheduler)
- `src/database/models.py` (–¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `follow_up_count`)

### –õ–æ–≥–∏–∫–∞

```python
# scheduler.py
async def check_follow_ups():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–¥–æ–≤ –¥–ª—è follow-up (–∫–∞–∂–¥—ã–π —á–∞—Å)."""
    cutoff = datetime.utcnow() - timedelta(hours=24)

    leads = await Lead.filter(
        last_message_at__lt=cutoff,
        status__in=[LeadStatus.NEW, LeadStatus.WARM],
        follow_up_count__lt=2
    )

    for lead in leads:
        await send_follow_up(lead)
        lead.follow_up_count += 1
        await lead.save()
```

### –°–æ–æ–±—â–µ–Ω–∏–µ follow-up

```
–ü—Ä–∏–≤–µ—Ç! üëã

–ó–∞–º–µ—Ç–∏–ª, —á—Ç–æ –≤—ã –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏. –í—Å—ë –µ—â—ë –∞–∫—Ç—É–∞–ª–µ–Ω –≤–∞—à –≤–æ–ø—Ä–æ—Å?

–ï—Å–ª–∏ –¥–∞ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ, –ø–æ–º–æ–≥—É!
```

### –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ ‚Äî –ª–∏–¥ –ø–æ–ª—É—á–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
- –ß–µ—Ä–µ–∑ 48 —á–∞—Å–æ–≤ ‚Äî –≤—Ç–æ—Ä–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
- –ü–æ—Å–ª–µ 2-—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ‚Äî —Å—Ç–∞—Ç—É—Å COLD

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **Retry –¥–ª—è Claude** (30 –º–∏–Ω) ‚Äî –±—ã—Å—Ç—Ä–æ –∏ –≤–∞–∂–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞** (30 –º–∏–Ω) ‚Äî —ç–∫–æ–Ω–æ–º–∏—è –¥–µ–Ω–µ–≥
3. **–ü–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏** (1-2 —á–∞—Å–∞) ‚Äî —É–ª—É—á—à–µ–Ω–∏–µ UX
4. **Follow-up** (2-3 —á–∞—Å–∞) ‚Äî –∫–∏–ª–ª–µ—Ä-—Ñ–∏—á–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```toml
# pyproject.toml
"tenacity>=8.2.0"  # –î–ª—è retry
```

---

**–ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 22.12.2025
