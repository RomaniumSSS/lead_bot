# Plan 002: Внедрение MyPy и улучшение типизации проекта

## Objective (Цель)

Установить MyPy, добавить строгую типизацию во весь код проекта и настроить автоматические проверки типов для повышения качества кода и упрощения его расширения.

## Context (Контекст)

- Проект использует Python 3.11+ с async/await
- Уже есть базовая типизация в некоторых местах (Optional, Dict, Any)
- Нет MyPy в зависимостях и конфигурации
- Много функций без аннотаций типов или с неполными аннотациями
- Используются библиотеки: aiogram, tortoise-orm, anthropic, pydantic-settings

## Proposed Steps (Предлагаемые шаги)

### 1. Установка MyPy
- [ ] Добавить `mypy` в dev-зависимости в `pyproject.toml`
- [ ] Добавить типы для библиотек: `types-python-dateutil` (если нужно)
- [ ] Установить зависимости через `uv sync`

### 2. Создание конфигурации MyPy
- [ ] Создать `pyproject.toml` секцию `[tool.mypy]` с правильными настройками:
  - Строгий режим для проекта (`strict = true`)
  - Игнорирование сторонних библиотек без типов
  - Настройка плагинов для Pydantic
- [ ] Добавить настройки для конкретных модулей (если нужно)

### 3. Типизация модулей database
- [ ] `database/models.py`: Добавить типы для методов `__str__`
- [ ] `database/config.py`: Проверить и добавить типы (если нужно)

### 4. Типизация модулей handlers
- [ ] `handlers/start.py`: 
  - Добавить типы для всех параметров
  - Убедиться, что Optional используется правильно
- [ ] `handlers/conversation.py`:
  - Типизировать переменные внутри функций
  - Добавить типы для response_data
- [ ] `handlers/admin.py`:
  - Типизировать функцию `is_owner`
  - Добавить типы для всех переменных

### 5. Типизация модулей services
- [ ] `services/llm.py`:
  - Заменить `Dict[str, Any]` на TypedDict или Pydantic модель
  - Добавить строгие типы для возвращаемых значений
  - Типизировать все внутренние переменные
- [ ] `services/notifier.py`:
  - Добавить типы для всех функций
  - Убедиться в правильности Optional

### 6. Типизация модулей utils и middlewares
- [ ] `utils/logger.py`: Добавить типы для всех функций
- [ ] `middlewares/logging.py`: Добавить типы для middleware класса
- [ ] `config.py`: Проверить типизацию Settings

### 7. Типизация главного модуля
- [ ] `bot.py`: Добавить типы для всех функций и переменных

### 8. Создание типов для улучшения читаемости
- [ ] Создать файл `src/types.py` с:
  - TypedDict для ответа LLM
  - Алиасы типов для часто используемых структур
  - Protocol для расширяемости (если нужно)

### 9. Запуск MyPy и исправление ошибок
- [ ] Запустить `mypy src/` и собрать все ошибки
- [ ] Исправить критические ошибки типов
- [ ] Добавить `# type: ignore` только где действительно необходимо (с комментариями AICODE-NOTE)

### 10. Настройка pre-commit hooks (опционально)
- [ ] Создать `.pre-commit-config.yaml`
- [ ] Добавить MyPy в pre-commit hooks
- [ ] Добавить Ruff для линтинга и форматирования

### 11. Обновление документации
- [ ] Обновить README.md с инструкциями по запуску MyPy
- [ ] Обновить docs/tech.md с информацией о типизации
- [ ] Добавить в AGENTS.md правила работы с типами

## Risks (Риски)

1. **MyPy может найти много ошибок в существующем коде**
   - Mitigation: Начнём с менее строгого режима, постепенно ужесточим
   
2. **Библиотеки без типов (aiogram, tortoise-orm) могут вызывать ложные срабатывания**
   - Mitigation: Используем ignore для конкретных библиотек в конфиге

3. **Async/await может вызывать сложности с типизацией**
   - Mitigation: Используем правильные аннотации с Awaitable, Coroutine

4. **Длительный процесс исправления всех ошибок**
   - Mitigation: Разделим на этапы, сначала критичное, потом остальное

## Rollback Strategy (Стратегия отката)

Если MyPy вызывает слишком много проблем:
1. Удалить MyPy из зависимостей
2. Откатить изменения в pyproject.toml
3. Сохранить добавленные типы в коде (они не навредят)

Git коммиты:
1. Коммит 1: Установка MyPy + конфигурация
2. Коммит 2: Типизация database и handlers
3. Коммит 3: Типизация services
4. Коммит 4: Типизация остального + исправление ошибок
5. Коммит 5: Pre-commit hooks + документация

## Success Criteria (Критерии успеха)

1. ✅ MyPy установлен и настроен в pyproject.toml
2. ✅ `mypy src/` выполняется без критических ошибок (error: 0)
3. ✅ Все публичные функции имеют полные аннотации типов
4. ✅ Код остаётся рабочим (бот запускается и обрабатывает сообщения)
5. ✅ Документация обновлена
6. ✅ (Опционально) Pre-commit hooks настроены для автоматической проверки

## Notes

- Используем строгий режим MyPy для максимальной безопасности типов
- Приоритет: публичные API → внутренние функции → переменные
- Избегаем `Any` где возможно
- Документируем сложные типы через AICODE-NOTE

